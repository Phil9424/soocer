{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="game-page match-page">
        <div class="match-timer">
            <span id="timer-display">{{ match_data.minute }}'</span>
            <span id="added-time" style="display: none;"></span>
        </div>
        
        <div class="match-score">
            <div class="score-display">
                <span class="score-number" id="my-score">{{ match_data.my_score }}</span>
                <span class="score-separator">-</span>
                <span class="score-number" id="opponent-score">{{ match_data.opponent_score }}</span>
            </div>
            <div class="score-teams">
                <div class="team-score-section">
                    {% set my_logo = TEAM_LOGOS.get(my_team, TEAM_LOGOS_FALLBACK.get(my_team, '')) %}
                    {% if my_logo %}
                    <img src="{{ my_logo }}" alt="{{ my_team }}" class="team-logo-tiny" style="width: 30px !important; height: 30px !important; object-fit: contain !important;">
                    {% else %}
                    <div class="team-logo-placeholder-tiny">‚öΩ</div>
                    {% endif %}
                    <span class="team-name-small">{{ my_team }}</span>
                    <div class="goals-list" id="my-goals-list">
                        {% for goal in match_data.goals %}
                            {% if goal.team == my_team %}
                                <div class="goal-item">{{ goal.scorer }} {{ goal.minute }}'</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <div class="team-score-section">
                    {% set opp_logo = TEAM_LOGOS.get(opponent_team, TEAM_LOGOS_FALLBACK.get(opponent_team, '')) %}
                    {% if opp_logo %}
                    <img src="{{ opp_logo }}" alt="{{ opponent_team }}" class="team-logo-tiny" style="width: 30px !important; height: 30px !important; object-fit: contain !important;">
                    {% else %}
                    <div class="team-logo-placeholder-tiny">‚öΩ</div>
                    {% endif %}
                    <span class="team-name-small">{{ opponent_team }}</span>
                    <div class="goals-list" id="opponent-goals-list">
                        {% for goal in match_data.goals %}
                            {% if goal.team == opponent_team %}
                                <div class="goal-item">{{ goal.scorer }} {{ goal.minute }}'</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="match-stats">
            <div class="stat-row">
                <div class="stat-label">‚öΩ –í–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º</div>
                <div class="stat-bars">
                    <div class="stat-bar-container">
                        <div class="stat-bar my-bar" style="width: {{ match_data.possession_my }}%"></div>
                        <span class="stat-value">{{ match_data.possession_my }}%</span>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar opponent-bar" style="width: {{ match_data.possession_opponent }}%"></div>
                        <span class="stat-value">{{ match_data.possession_opponent }}%</span>
                    </div>
                </div>
            </div>
            
            <div class="stat-row">
                <div class="stat-label">üéØ –£–¥–∞—Ä—ã</div>
                <div class="stat-bars">
                    <div class="stat-bar-container">
                        <div class="stat-bar my-bar" style="width: {{ shots_my_percent }}%"></div>
                        <span class="stat-value">{{ match_data.shots_my }}</span>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar opponent-bar" style="width: {{ shots_opponent_percent }}%"></div>
                        <span class="stat-value">{{ match_data.shots_opponent }}</span>
                    </div>
                </div>
            </div>
            
            <div class="stat-row">
                <div class="stat-label">‚úÖ –£–¥–∞—Ä—ã –≤ —Å—Ç–≤–æ—Ä</div>
                <div class="stat-bars">
                    <div class="stat-bar-container">
                        <div class="stat-bar my-bar" style="width: {{ shots_on_target_my_percent }}%"></div>
                        <span class="stat-value">{{ match_data.shots_on_target_my }}</span>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar opponent-bar" style="width: {{ shots_on_target_opponent_percent }}%"></div>
                        <span class="stat-value">{{ match_data.shots_on_target_opponent }}</span>
                    </div>
                </div>
            </div>
            
            <div class="stat-row">
                <div class="stat-label">üìä xG (Expected Goals)</div>
                <div class="stat-bars">
                    <div class="stat-bar-container">
                        <div class="stat-bar my-bar" style="width: {{ xg_my_percent }}%"></div>
                        <span class="stat-value">{{ "%.2f"|format(match_data.xg_my) }}</span>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar opponent-bar" style="width: {{ xg_opponent_percent }}%"></div>
                        <span class="stat-value">{{ "%.2f"|format(match_data.xg_opponent) }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="match-controls">
            {% if match_data.half == 1 and match_data.minute >= 47 %}
                <button class="btn btn-success" id="start-second-half-btn" onclick="startSecondHalf()" style="font-size: 1.2rem; padding: 1rem 2rem;">‚è±Ô∏è –ù–∞—á–∞—Ç—å 2 —Ç–∞–π–º</button>
            {% elif match_data.half == 2 and match_data.minute >= 85 %}
                <button class="btn btn-success" id="end-match-btn" onclick="endMatch()" style="font-size: 1.2rem; padding: 1rem 2rem;">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ç—á</button>
            {% else %}
                <button class="btn btn-secondary" onclick="showSubstitutions()">üîÑ –ó–∞–º–µ–Ω—ã</button>
                <button class="btn btn-primary" onclick="showTactics()">‚öΩ –¢–∞–∫—Ç–∏–∫–∞</button>
            {% endif %}
        </div>
        
        <div id="goal-notification" class="goal-notification" style="display: none;">
            <div class="goal-text">
                <div class="goal-scorer" id="goal-scorer"></div>
                <div class="goal-minute" id="goal-minute"></div>
            </div>
        </div>
    </div>
</div>

<script>
let currentMinute = {{ match_data.minute }};
let currentHalf = {{ match_data.half }};
let timerInterval = null;
let isRunning = false;
let lastGoalCount = {{ match_data.goals|length }};

// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const timerDisplay = document.getElementById('timer-display');
const addedTimeEl = document.getElementById('added-time');

// –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–π–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ç–∞–π–º–∞
if (currentHalf === 2 && currentMinute < 46) {
    currentMinute = 46;
    if (timerDisplay) {
        timerDisplay.textContent = '46' + "'";
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –ª–∏ —É–∂–µ –º–∞—Ç—á –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–±–∞–≤–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if (currentHalf === 1) {
    if (currentMinute >= 47) {
        isRunning = false;
        if (addedTimeEl && currentMinute > 45) {
            addedTimeEl.textContent = '+' + (currentMinute - 45);
            addedTimeEl.style.display = 'inline';
        }
        showStartSecondHalfButton();
    } else {
        isRunning = true;
        if (currentMinute > 45 && addedTimeEl) {
            addedTimeEl.textContent = '+' + (currentMinute - 45);
            addedTimeEl.style.display = 'inline';
        }
    }
} else if (currentHalf === 2) {
    if (currentMinute >= 92) {
        isRunning = false;
        if (addedTimeEl && currentMinute > 90) {
            addedTimeEl.textContent = '+' + (currentMinute - 90);
            addedTimeEl.style.display = 'inline';
        }
        showEndMatchButton();
    } else {
        isRunning = true;
        if (currentMinute > 90 && addedTimeEl) {
            addedTimeEl.textContent = '+' + (currentMinute - 90);
            addedTimeEl.style.display = 'inline';
        }
    }
} else {
    isRunning = true;
}

function updateTimer() {
    if (!isRunning) return;
    
    currentMinute++;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const timerDisplay = document.getElementById('timer-display');
    const addedTimeEl = document.getElementById('added-time');
    
    if (currentHalf === 1) {
        if (currentMinute <= 45) {
            timerDisplay.textContent = currentMinute + "'";
            if (addedTimeEl) addedTimeEl.style.display = 'none';
        } else {
            timerDisplay.textContent = "45'";
            if (addedTimeEl) {
                const added = currentMinute - 45;
                addedTimeEl.textContent = "+" + added;
                addedTimeEl.style.display = 'inline';
            }
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Å–ª–µ 45+2 –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            if (currentMinute >= 47) {
                isRunning = false;
                clearInterval(timerInterval);
                showStartSecondHalfButton();
                return;
            }
        }
    } else if (currentHalf === 2) {
        if (currentMinute <= 90) {
            timerDisplay.textContent = currentMinute + "'";
            if (addedTimeEl) addedTimeEl.style.display = 'none';
        } else {
            timerDisplay.textContent = "90'";
            if (addedTimeEl) {
                const added = currentMinute - 90;
                addedTimeEl.textContent = "+" + added;
                addedTimeEl.style.display = 'inline';
            }
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Å–ª–µ 90+2 –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –û–ö
            if (currentMinute >= 87) {
                isRunning = false;
                clearInterval(timerInterval);
                showEndMatchButton();
                return;
            }
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    fetch('{{ url_for("match_action") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'tick',
            minute: currentMinute,
            half: currentHalf
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.match_data) {
            updateStats(data.match_data);
            checkNewGoals(data.match_data);
        }
    });
}

function updateStats(matchData) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
    document.getElementById('my-score').textContent = matchData.my_score;
    document.getElementById('opponent-score').textContent = matchData.opponent_score;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
    currentMinute = matchData.minute;
    currentHalf = matchData.half;
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–π–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ç–∞–π–º–∞
    if (currentHalf === 2 && currentMinute < 46) {
        currentMinute = 46;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
    if (timerDisplay) {
        if (currentHalf === 1) {
            if (currentMinute <= 45) {
                timerDisplay.textContent = currentMinute + "'";
                if (addedTimeEl) addedTimeEl.style.display = 'none';
            } else {
                timerDisplay.textContent = "45'";
                if (addedTimeEl) {
                    addedTimeEl.textContent = "+" + (currentMinute - 45);
                    addedTimeEl.style.display = 'inline';
                }
            }
        } else if (currentHalf === 2) {
            if (currentMinute <= 90) {
                timerDisplay.textContent = currentMinute + "'";
                if (addedTimeEl) addedTimeEl.style.display = 'none';
            } else {
                timerDisplay.textContent = "90'";
                if (addedTimeEl) {
                    addedTimeEl.textContent = "+" + (currentMinute - 90);
                    addedTimeEl.style.display = 'inline';
                }
            }
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateStatBars(matchData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ–ª–æ–≤
    updateGoalsList(matchData);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏
    if (matchData.half === 1 && matchData.minute >= 47) {
        showStartSecondHalfButton();
    } else if (matchData.half === 2 && matchData.minute >= 92) {
        showEndMatchButton();
    }
}

function showStartSecondHalfButton() {
    const controls = document.querySelector('.match-controls');
    if (controls && !document.getElementById('start-second-half-btn')) {
        controls.innerHTML = '<button class="btn btn-success" id="start-second-half-btn" onclick="startSecondHalf()" style="font-size: 1.2rem; padding: 1rem 2rem;">‚è±Ô∏è –ù–∞—á–∞—Ç—å 2 —Ç–∞–π–º</button>';
    }
}

function showEndMatchButton() {
    const controls = document.querySelector('.match-controls');
    if (controls && !document.getElementById('end-match-btn')) {
        controls.innerHTML = '<button class="btn btn-success" id="end-match-btn" onclick="endMatch()" style="font-size: 1.2rem; padding: 1rem 2rem;">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ç—á</button>';
    }
}

function updateStatBars(matchData) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–ª–∞–¥–µ–Ω–∏–µ
    const possessionBars = document.querySelectorAll('.stat-row:first-child .stat-bar');
    if (possessionBars.length >= 2) {
        possessionBars[0].style.width = matchData.possession_my + '%';
        possessionBars[1].style.width = matchData.possession_opponent + '%';
        const possessionValues = document.querySelectorAll('.stat-row:first-child .stat-value');
        if (possessionValues.length >= 2) {
            possessionValues[0].textContent = matchData.possession_my + '%';
            possessionValues[1].textContent = matchData.possession_opponent + '%';
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —É–¥–∞—Ä—ã
    const totalShots = Math.max(matchData.shots_my + matchData.shots_opponent, 1);
    const shotsMyPercent = (matchData.shots_my / totalShots) * 100;
    const shotsOppPercent = (matchData.shots_opponent / totalShots) * 100;
    const shotsBars = document.querySelectorAll('.stat-row:nth-child(2) .stat-bar');
    if (shotsBars.length >= 2) {
        shotsBars[0].style.width = shotsMyPercent + '%';
        shotsBars[1].style.width = shotsOppPercent + '%';
        const shotsValues = document.querySelectorAll('.stat-row:nth-child(2) .stat-value');
        if (shotsValues.length >= 2) {
            shotsValues[0].textContent = matchData.shots_my;
            shotsValues[1].textContent = matchData.shots_opponent;
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —É–¥–∞—Ä—ã –≤ —Å—Ç–≤–æ—Ä
    const totalShotsOnTarget = Math.max(matchData.shots_on_target_my + matchData.shots_on_target_opponent, 1);
    const shotsOnTargetMyPercent = (matchData.shots_on_target_my / totalShotsOnTarget) * 100;
    const shotsOnTargetOppPercent = (matchData.shots_on_target_opponent / totalShotsOnTarget) * 100;
    const shotsOnTargetBars = document.querySelectorAll('.stat-row:nth-child(3) .stat-bar');
    if (shotsOnTargetBars.length >= 2) {
        shotsOnTargetBars[0].style.width = shotsOnTargetMyPercent + '%';
        shotsOnTargetBars[1].style.width = shotsOnTargetOppPercent + '%';
        const shotsOnTargetValues = document.querySelectorAll('.stat-row:nth-child(3) .stat-value');
        if (shotsOnTargetValues.length >= 2) {
            shotsOnTargetValues[0].textContent = matchData.shots_on_target_my;
            shotsOnTargetValues[1].textContent = matchData.shots_on_target_opponent;
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º xG
    const totalXg = Math.max(matchData.xg_my + matchData.xg_opponent, 0.1);
    const xgMyPercent = (matchData.xg_my / totalXg) * 100;
    const xgOppPercent = (matchData.xg_opponent / totalXg) * 100;
    const xgBars = document.querySelectorAll('.stat-row:nth-child(4) .stat-bar');
    if (xgBars.length >= 2) {
        xgBars[0].style.width = xgMyPercent + '%';
        xgBars[1].style.width = xgOppPercent + '%';
        const xgValues = document.querySelectorAll('.stat-row:nth-child(4) .stat-value');
        if (xgValues.length >= 2) {
            xgValues[0].textContent = matchData.xg_my.toFixed(2);
            xgValues[1].textContent = matchData.xg_opponent.toFixed(2);
        }
    }
}

function checkNewGoals(matchData) {
    const goals = matchData.goals || [];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –≥–æ–ª—ã
    if (goals.length > lastGoalCount) {
        const newGoal = goals[goals.length - 1];
        showGoalNotification(newGoal);
        updateGoalsList(matchData);
        lastGoalCount = goals.length;
    }
}

function updateGoalsList(matchData) {
    const myGoalsList = document.getElementById('my-goals-list');
    const opponentGoalsList = document.getElementById('opponent-goals-list');
    
    if (myGoalsList && opponentGoalsList) {
        myGoalsList.innerHTML = '';
        opponentGoalsList.innerHTML = '';
        
        matchData.goals.forEach(goal => {
            const goalItem = document.createElement('div');
            goalItem.className = 'goal-item';
            goalItem.textContent = goal.scorer + ' ' + goal.minute + "'";
            
            if (goal.team === '{{ my_team }}') {
                myGoalsList.appendChild(goalItem);
            } else {
                opponentGoalsList.appendChild(goalItem);
            }
        });
    }
}

function showGoalNotification(goal) {
    const notification = document.getElementById('goal-notification');
    const scorer = document.getElementById('goal-scorer');
    const minute = document.getElementById('goal-minute');
    
    scorer.textContent = goal.scorer + " " + goal.minute + "'";
    minute.textContent = goal.team;
    
    notification.style.display = 'flex';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç —Å—Ä–∞–∑—É
    const myScoreEl = document.getElementById('my-score');
    const oppScoreEl = document.getElementById('opponent-score');
    
    if (goal.team === '{{ my_team }}') {
        myScoreEl.textContent = parseInt(myScoreEl.textContent) + 1;
    } else {
        oppScoreEl.textContent = parseInt(oppScoreEl.textContent) + 1;
    }
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function startSecondHalf() {
    isRunning = false;
    clearInterval(timerInterval);
    
    fetch('{{ url_for("match_action") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'start_second_half'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.match_data) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            currentHalf = 2;
            currentMinute = 46;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
            const timerDisplay = document.getElementById('timer-display');
            const addedTimeEl = document.getElementById('added-time');
            if (timerDisplay) {
                timerDisplay.textContent = '46' + "'";
            }
            if (addedTimeEl) {
                addedTimeEl.style.display = 'none';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            const controls = document.querySelector('.match-controls');
            if (controls) {
                controls.innerHTML = '<button class="btn btn-secondary" onclick="showSubstitutions()">üîÑ –ó–∞–º–µ–Ω—ã</button>';
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–Ω–æ–≤–∞
            isRunning = true;
            timerInterval = setInterval(updateTimer, 333);
        }
    });
}

function showSeasonEndModal(seasonData) {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.5s ease;
    `;

    const position = seasonData.final_position;
    let emoji = 'ü•á';
    let message = '';

    if (position === 1) {
        message = '–ß–µ–º–ø–∏–æ–Ω –ê–Ω–≥–ª–∏–∏!';
        emoji = 'ü•á';
    } else if (position === 2) {
        message = '–í—Ç–æ—Ä–æ–µ –º–µ—Å—Ç–æ!';
        emoji = 'ü•à';
    } else if (position === 3) {
        message = '–¢—Ä–µ—Ç—å–µ –º–µ—Å—Ç–æ!';
        emoji = 'ü•â';
    } else if (position >= 4 && position <= 7) {
        message = '–£—á–∞—Å—Ç–∏–µ –≤ –õ–∏–≥–µ –ï–≤—Ä–æ–ø—ã!';
        emoji = 'üåü';
    } else if (position >= 18) {
        message = '–í—ã–ª–µ—Ç –≤ –ß–µ–º–ø–∏–æ–Ω—à–∏–ø!';
        emoji = 'üìâ';
    } else {
        message = '–°–µ–∑–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!';
        emoji = '‚öΩ';
    }

    modal.innerHTML = `
        <div style="
            background: linear-gradient(135deg, var(--primary-color), var(--light-blue));
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: slideUp 0.5s ease;
        ">
            <h1 style="color: white; font-size: 3rem; margin-bottom: 1rem;">${emoji}</h1>
            <h2 style="color: white; font-size: 2rem; margin-bottom: 0.5rem;">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
            <p style="color: white; font-size: 1.5rem; margin-bottom: 0.5rem;">
                –í—ã –∑–∞–Ω—è–ª–∏ <strong>${position}${getOrdinalSuffix(position)}</strong> –º–µ—Å—Ç–æ!
            </p>
            <p style="color: white; font-size: 1.2rem; margin-bottom: 2rem;">
                ${message}
            </p>
            <button onclick="continueToResults()" style="
                background: white;
                color: var(--primary-color);
                border: none;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-size: 1.1rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ç–æ–≥–∏ —Å–µ–∑–æ–Ω–∞
            </button>
        </div>
    `;

    document.body.appendChild(modal);

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}

function getOrdinalSuffix(position) {
    if (position === 1) return '-–µ';
    if (position >= 2 && position <= 4) return '-–µ';
    return '-–µ';
}

function continueToResults() {
    window.location.href = '{{ url_for("match_results") }}';
}

function endMatch() {
    isRunning = false;
    clearInterval(timerInterval);
    
    fetch('{{ url_for("match_action") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'end_match'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.season_end) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∏—Ç–æ–≥–æ–≤—ã–º –º–µ—Å—Ç–æ–º
                showSeasonEndModal(data.season_end_data);
            } else {
                window.location.href = '{{ url_for("match_results") }}';
            }
        }
    });
}

function showTactics() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    modal.innerHTML = `
        <div style="
            background: var(--card-bg, #2a2a2a);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--accent-yellow, #ffc107);
        ">
            <h2 style="color: var(--text-primary, white); text-align: center; margin-bottom: 1.5rem;">‚öΩ –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞–∫—Ç–∏–∫—É</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="tactic-option" data-tactic="balanced" style="
                    background: var(--bg-secondary, #3a3a3a);
                    border: 2px solid var(--border-color, #555);
                    border-radius: 8px;
                    padding: 1rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <h3 style="color: var(--text-primary, white); margin-bottom: 0.5rem;">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞</h3>
                    <p style="color: var(--text-secondary, #ccc); font-size: 0.9rem; margin: 0;">–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–∫—Ç–∏–∫–∞ 50/50</p>
                </div>

                <div class="tactic-option" data-tactic="tiki_taka" style="
                    background: var(--bg-secondary, #3a3a3a);
                    border: 2px solid var(--border-color, #555);
                    border-radius: 8px;
                    padding: 1rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <h3 style="color: var(--text-primary, white); margin-bottom: 0.5rem;">–¢–∏–∫–∏-—Ç–∞–∫–∞</h3>
                    <p style="color: var(--text-secondary, #ccc); font-size: 0.9rem; margin: 0;">–í—ã—Å–æ–∫–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º, —Å–ø–æ–∫–æ–π–Ω—ã–π —Ñ—É—Ç–±–æ–ª</p>
                </div>

                <div class="tactic-option" data-tactic="catenaccio" style="
                    background: var(--bg-secondary, #3a3a3a);
                    border: 2px solid var(--border-color, #555);
                    border-radius: 8px;
                    padding: 1rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <h3 style="color: var(--text-primary, white); margin-bottom: 0.5rem;">–ö–∞—Ç–µ–Ω–∞—á—á–æ</h3>
                    <p style="color: var(--text-secondary, #ccc); font-size: 0.9rem; margin: 0;">–ê—Ç–∞–∫–∞ –ø–æ—Å–ª–µ –≥–æ–ª–∞, –∑–∞—Ç–µ–º –æ–±–æ—Ä–æ–Ω–∞</p>
                </div>

                <div class="tactic-option" data-tactic="bus" style="
                    background: var(--bg-secondary, #3a3a3a);
                    border: 2px solid var(--border-color, #555);
                    border-radius: 8px;
                    padding: 1rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <h3 style="color: var(--text-primary, white); margin-bottom: 0.5rem;">–ê–≤—Ç–æ–±—É—Å</h3>
                    <p style="color: var(--text-secondary, #ccc); font-size: 0.9rem; margin: 0;">–ì–ª—É—Ö–∞—è –æ–±–æ—Ä–æ–Ω–∞</p>
                </div>

                <div class="tactic-option" data-tactic="all_out_attack" style="
                    background: var(--bg-secondary, #3a3a3a);
                    border: 2px solid var(--border-color, #555);
                    border-radius: 8px;
                    padding: 1rem;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <h3 style="color: var(--text-primary, white); margin-bottom: 0.5rem;">–í—Å–µ –≤ –∞—Ç–∞–∫—É</h3>
                    <p style="color: var(--text-secondary, #ccc); font-size: 0.9rem; margin: 0;">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∞—Ç–∞–∫–∞</p>
                </div>
            </div>

            <div style="text-align: center;">
                <button onclick="modal.remove()" style="
                    background: var(--accent-red, #dc3545);
                    color: white;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 1rem;
                ">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞–∫—Ç–∏–∫–∏
    modal.querySelectorAll('.tactic-option').forEach(option => {
        option.addEventListener('click', function() {
            const tactic = this.dataset.tactic;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–∫—Ç–∏–∫–∏
            fetch('/change_tactic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tactic: tactic
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    modal.remove();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–∫—Ç–∏–∫–∏:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–∫—Ç–∏–∫–∏');
            });
        });

        // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        option.addEventListener('mouseenter', function() {
            this.style.borderColor = 'var(--accent-yellow, #ffc107)';
            this.style.transform = 'translateY(-2px)';
        });

        option.addEventListener('mouseleave', function() {
            this.style.borderColor = 'var(--border-color, #555)';
            this.style.transform = 'translateY(0)';
        });
    });

    document.body.appendChild(modal);
}

function showSubstitutions() {
    alert('üîÑ –§—É–Ω–∫—Ü–∏—è –∑–∞–º–µ–Ω –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–≤ 3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ: 333ms = 1 –∏–≥—Ä–æ–≤–∞—è –º–∏–Ω—É—Ç–∞)
if (isRunning) {
    timerInterval = setInterval(updateTimer, 333);
}
</script>
{% endblock %}

