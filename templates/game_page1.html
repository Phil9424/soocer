{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="game-page" style="min-height: 100vh !important; padding-bottom: 2rem !important;">
        <div class="team-header">
            <h1 style="font-size: 1.5rem !important; font-weight: 800 !important; margin: 0 !important;">ğŸ† {{ data.team_name }}</h1>
        </div>

        <div class="team-info" style="display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 0.8rem !important; margin: 1.5rem 0 !important;">
            <div class="info-card" style="background: var(--bg-card) !important; border-radius: 12px !important; padding: 1.5rem 1rem !important; box-shadow: var(--shadow-md) !important; text-align: center !important; min-height: 110px !important; display: flex !important; flex-direction: column !important; justify-content: center !important;">
                <div class="info-label" style="font-size: 2rem !important; margin-bottom: 0.5rem !important;">ğŸ“Š</div>
                <div class="info-value" style="font-size: 1rem !important; font-weight: 600 !important;">{{ data.division }}</div>
            </div>
            <div class="info-card" style="background: var(--bg-card) !important; border-radius: 12px !important; padding: 1.5rem 1rem !important; box-shadow: var(--shadow-md) !important; text-align: center !important; min-height: 110px !important; display: flex !important; flex-direction: column !important; justify-content: center !important;">
                <div class="info-label" style="font-size: 2rem !important; margin-bottom: 0.5rem !important;">ğŸ“…</div>
                <div class="info-value" style="font-size: 1rem !important; font-weight: 600 !important;">Ğ¢ÑƒÑ€ {{ data.current_round }}</div>
            </div>
            <div class="info-card" style="background: var(--bg-card) !important; border-radius: 12px !important; padding: 1.5rem 1rem !important; box-shadow: var(--shadow-md) !important; text-align: center !important; min-height: 110px !important; display: flex !important; flex-direction: column !important; justify-content: center !important;">
                <div class="info-label" style="font-size: 2rem !important; margin-bottom: 0.5rem !important;">ğŸ“</div>
                <div class="info-value" style="font-size: 1rem !important; font-weight: 600 !important;">#{{ data.position }}</div>
            </div>
            <div class="info-card" style="background: var(--bg-card) !important; border-radius: 12px !important; padding: 1.5rem 1rem !important; box-shadow: var(--shadow-md) !important; text-align: center !important; min-height: 110px !important; display: flex !important; flex-direction: column !important; justify-content: center !important;">
                <div class="info-label" style="font-size: 2rem !important; margin-bottom: 0.5rem !important;">â­</div>
                <div class="info-value" style="font-size: 1rem !important; font-weight: 600 !important;">{{ data.points }}</div>
            </div>
            <div class="info-card" style="background: var(--bg-card) !important; border-radius: 12px !important; padding: 1.5rem 1rem !important; box-shadow: var(--shadow-md) !important; text-align: center !important; min-height: 110px !important; display: flex !important; flex-direction: column !important; justify-content: center !important;">
                <div class="info-label" style="font-size: 2rem !important; margin-bottom: 0.5rem !important;">ğŸŸï¸</div>
                <div class="info-value" style="font-size: 0.9rem !important; font-weight: 600 !important;">{{ data.stadium }}</div>
            </div>
            <div class="info-card" style="background: var(--bg-card) !important; border-radius: 12px !important; padding: 1.5rem 1rem !important; box-shadow: var(--shadow-md) !important; text-align: center !important; min-height: 110px !important; display: flex !important; flex-direction: column !important; justify-content: center !important;">
                <div class="info-label" style="font-size: 2rem !important; margin-bottom: 0.5rem !important;">ğŸ’°</div>
                <div class="info-value" style="font-size: 1rem !important; font-weight: 600 !important;">Â£{{ "{:,.0f}".format(data.finances / 1000) }}k</div>
            </div>
        </div>

        <div class="next-match" style="background: linear-gradient(135deg, var(--primary-color), var(--light-blue)) !important; border-radius: 16px !important; padding: 2rem 1.5rem !important; margin: 2rem 0 !important; text-align: center !important; color: white !important; box-shadow: var(--shadow-md) !important;">
            <h3 style="font-size: 1.8rem !important; font-weight: 800 !important; margin: 0 0 0.5rem 0 !important;">âš½ {{ data.next_opponent }}</h3>
            <p style="font-size: 1rem !important; opacity: 0.95 !important; margin: 0 !important; font-weight: 500 !important;">
                {% if data.is_home_match %}ğŸ  Ğ”Ğ¾Ğ¼Ğ°{% else %}âœˆï¸ Ğ’ Ğ³Ğ¾ÑÑ‚ÑÑ…{% endif %} â€¢ Ğ¢ÑƒÑ€ {{ data.current_round }}/38
            </p>
        </div>

        <div class="action-buttons" style="display: grid !important; grid-template-columns: repeat(2, 1fr) !important; grid-template-rows: repeat(2, 1fr) !important; gap: 0.8rem !important; margin: 2rem 0 !important;">
            <a href="{{ url_for('pre_match') }}" class="btn btn-success" style="padding: 1.2rem 1rem !important; font-size: 1rem !important; font-weight: 700 !important; border-radius: 12px !important;">
                ğŸ® ĞœĞ°Ñ‚Ñ‡
            </a>
            <button class="btn btn-primary" onclick="saveGame()" style="padding: 1.2rem 1rem !important; font-size: 1rem !important; font-weight: 700 !important; border-radius: 12px !important;">
                ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€.
            </button>
            <a href="{{ url_for('game_page', page=2) }}" class="btn btn-info" style="padding: 1.2rem 1rem !important; font-size: 1rem !important; font-weight: 700 !important; border-radius: 12px !important;">
                ğŸ“Š Ğ¢Ğ°Ğ±Ğ».
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-danger" style="padding: 1.2rem 1rem !important; font-size: 1rem !important; font-weight: 700 !important; border-radius: 12px !important;">
                ğŸšª Ğ’Ñ‹Ñ…Ğ¾Ğ´
            </a>
        </div>
        
        <div class="page-navigation">
            <a href="{{ url_for('game_page', page=5) }}" class="nav-btn">â—€ ĞĞ°Ğ·Ğ°Ğ´</a>
            <span class="page-indicator">ğŸ“„ 1/5</span>
            <a href="{{ url_for('game_page', page=2) }}" class="nav-btn">Ğ’Ğ¿ĞµÑ€Ñ‘Ğ´ â–¶</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ Ğ² sessionStorage Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
try {
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° (data)
    const gameData = {{ data|tojson }};
    sessionStorage.setItem('game_data', JSON.stringify(gameData));
} catch (e) {
    console.log('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ Ğ² sessionStorage');
}

function saveGame() {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ğ»Ğ¸ Ğ¼Ñ‹ Ğ½Ğ° Vercel
    const isVercel = window.location.hostname.includes('vercel.app');

    if (isVercel) {
        // ĞĞ° Vercel ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² localStorage Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°
        try {
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¸Ğ· DOM
            const teamNameElement = document.querySelector('h1');
            const teamName = teamNameElement ? teamNameElement.textContent.replace('ğŸ† ', '').trim() : 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°';

            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ (ĞµÑĞ»Ğ¸ Ğ¼Ğ¾Ğ¶ĞµĞ¼)
            let gameData = null;
            try {
                // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· sessionStorage (ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ Ñ‚Ğ°Ğ¼ ĞµÑÑ‚ÑŒ)
                const sessionData = sessionStorage.getItem('game_data');
                if (sessionData) {
                    gameData = JSON.parse(sessionData);
                }
            } catch (e) {
                console.log('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ Ğ¸Ğ· sessionStorage');
            }

            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
            const saveData = {
                timestamp: new Date().toISOString(),
                teamName: teamName,
                gameData: gameData, // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
                note: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ (Vercel)'
            };

            // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² localStorage (Ğ¼Ğ¾Ğ¶ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾)
            const saves = JSON.parse(localStorage.getItem('football_manager_saves') || '[]');
            saves.push(saveData);

            // ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5 ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¹
            if (saves.length > 5) {
                saves.splice(0, saves.length - 5);
            }

            localStorage.setItem('football_manager_saves', JSON.stringify(saves));

            alert('âœ… Ğ˜Ğ³Ñ€Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ° Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ!\n\nğŸ’¡ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸.');
        } catch (error) {
            alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ: ' + error.message);
        }
    } else {
        // ĞĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ½Ğ° Ğ´Ğ¸ÑĞº
        fetch('{{ url_for("save_game") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('âœ… ' + data.message);
            } else {
                alert('âŒ ' + data.message);
            }
        })
        .catch(error => {
            alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ³Ñ€Ñ‹');
        });
    }
}
</script>
{% endblock %}

