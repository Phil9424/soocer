{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="game-page">
        <div class="team-header">
            <h1>üë• –°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã - <span id="selected-count" style="color: var(--accent-yellow);">{{ (data.selected_players|default([]))|length }}</span>/11</h1>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ç–∞–∫—Ç–∏–∫–∏ -->
        <div class="tactic-section">
            <div class="tactic-header" onclick="toggleTactics()">
                <h2>‚öΩ –¢–∞–∫—Ç–∏–∫–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–∞—Ç—á</h2>
                <span class="toggle-icon" id="tactic-toggle">‚ñº</span>
            </div>
            <div class="tactic-content" id="tactic-content">
                <div class="current-tactic">
                    <span>–¢–µ–∫—É—â–∞—è —Ç–∞–∫—Ç–∏–∫–∞: <strong id="current-tactic-name">{{ data.current_tactic|default('balanced') | replace('balanced', '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞') | replace('tiki_taka', '–¢–∏–∫–∏-—Ç–∞–∫–∞') | replace('catenaccio', '–ö–∞—Ç–µ–Ω–∞—á—á–æ') | replace('bus', '–ê–≤—Ç–æ–±—É—Å') | replace('all_out_attack', '–í—Å–µ –≤ –∞—Ç–∞–∫—É') }}</strong></span>
                </div>

                <div class="tactic-grid">
                    {% for tactic_key, tactic in [('balanced', {'name': '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞', 'description': '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–∫—Ç–∏–∫–∞ 50/50'}), ('tiki_taka', {'name': '–¢–∏–∫–∏-—Ç–∞–∫–∞', 'description': '–í—ã—Å–æ–∫–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º, —Å–ø–æ–∫–æ–π–Ω—ã–π —Ñ—É—Ç–±–æ–ª'}), ('catenaccio', {'name': '–ö–∞—Ç–µ–Ω–∞—á—á–æ', 'description': '–ê—Ç–∞–∫–∞ –ø–æ—Å–ª–µ –≥–æ–ª–∞, –∑–∞—Ç–µ–º –æ–±–æ—Ä–æ–Ω–∞'}), ('bus', {'name': '–ê–≤—Ç–æ–±—É—Å', 'description': '–ì–ª—É—Ö–∞—è –æ–±–æ—Ä–æ–Ω–∞'}), ('all_out_attack', {'name': '–í—Å–µ –≤ –∞—Ç–∞–∫—É', 'description': '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∞—Ç–∞–∫–∞'})] %}
                    <div class="tactic-card {% if data.current_tactic|default('balanced') == tactic_key %}active{% endif %}" data-tactic="{{ tactic_key }}">
                        <h3>{{ tactic.name }}</h3>
                        <p>{{ tactic.description }}</p>
                        <button class="btn btn-secondary select-tactic-btn" data-tactic="{{ tactic_key }}">–í—ã–±—Ä–∞—Ç—å</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="squad-list" id="squad-list">
            {% set selected_players_list = data.selected_players|default([]) %}
            
            {# –û—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤ (–ø–µ—Ä–≤—ã–µ 11) #}
            {% for i in range(11) %}
                {% if i < selected_players_list|length %}
                    {% set player_name = selected_players_list[i] %}
                    {% set player = data.squad|selectattr("name", "equalto", player_name)|first %}
                    {% if player %}
                        {# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Å—Ç–∞: 1=–í, 2-5=–ó, 6-9=–ü, 10-11=–ù #}
                        {% if i == 0 %}
                            {% set position = '–í' %}
                        {% elif i >= 1 and i <= 4 %}
                            {% set position = '–ó' %}
                        {% elif i >= 5 and i <= 8 %}
                            {% set position = '–ü' %}
                        {% else %}
                            {% set position = '–ù' %}
                        {% endif %}
                    <div class="player-item player-main" data-player-name="{{ player.name }}" data-position-index="{{ i }}">
                        <span class="player-position">{{ position }}</span>
                        <span class="player-real-position">({{ player.real_position }})</span>
                        <span class="player-name">{{ player.name }}</span>
                        {% if player.get('injury') or player.get('cards') %}
                        <span class="player-status">
                            {% if player.get('injury') %}üè•{% endif %}
                            {% if player.get('cards') == 1 %}üü®{% elif player.get('cards') == 2 %}üü•{% endif %}
                        </span>
                        {% endif %}
                        <span class="player-rating">{{ player.rating }}</span>
                    </div>
                    {% endif %}
                {% else %}
                    {# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –ø—É—Å—Ç–æ–≥–æ –º–µ—Å—Ç–∞ #}
                    {% if i == 0 %}
                        {% set position = '–í' %}
                    {% elif i >= 1 and i <= 4 %}
                        {% set position = '–ó' %}
                    {% elif i >= 5 and i <= 8 %}
                        {% set position = '–ü' %}
                    {% else %}
                        {% set position = '–ù' %}
                    {% endif %}
                    <div class="player-item player-main player-empty" data-position-index="{{ i }}">
                        <span class="player-position">{{ position }}</span>
                        <span class="player-name">–ü—É—Å—Ç–æ</span>
                        <span class="player-rating">-</span>
                    </div>
                {% endif %}
            {% endfor %}
            
            {# –ó–∞–ø–∞—Å–Ω—ã–µ #}
            {% for player in data.squad %}
                {% if player.name not in selected_players_list %}
                <div class="player-item player-bench" data-player-name="{{ player.name }}">
                    <span class="player-position">-</span>
                    <span class="player-real-position">({{ player.real_position }})</span>
                    <span class="player-name">{{ player.name }}</span>
                    {% if player.get('injury') or player.get('cards') %}
                    <span class="player-status">
                        {% if player.get('injury') %}üè•{% endif %}
                        {% if player.get('cards') == 1 %}üü®{% elif player.get('cards') == 2 %}üü•{% endif %}
                    </span>
                    {% endif %}
                    <span class="player-rating">{{ player.rating }}</span>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <div class="page-navigation">
            <a href="{{ url_for('game_page', page=2) }}" class="nav-btn">‚óÄ –ù–∞–∑–∞–¥</a>
            <span class="page-indicator">üìÑ 3/5</span>
            <a href="{{ url_for('game_page', page=4) }}" class="nav-btn">–í–ø–µ—Ä—ë–¥ ‚ñ∂</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedPlayer = null;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤
function handlePlayerClick(e) {
    e.stopPropagation();
    const item = this;
    
    if (item.classList.contains('player-empty')) return;
    
    // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω, –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
    if (!selectedPlayer) {
        selectedPlayer = item;
        item.classList.add('selected-for-swap');
        return;
    }
    
    // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ç–æ–≥–æ –∂–µ –∏–≥—Ä–æ–∫–∞, —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    if (selectedPlayer === item) {
        selectedPlayer.classList.remove('selected-for-swap');
        selectedPlayer = null;
        return;
    }
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤
    swapPlayers(selectedPlayer, item);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã swap (–∫–ª–∏–∫ –Ω–∞ –¥–≤—É—Ö –∏–≥—Ä–æ–∫–∞—Ö)
function initSwapSystem() {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    document.querySelectorAll('.player-item:not(.player-empty)').forEach(item => {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ addEventListener
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        newItem.addEventListener('click', handlePlayerClick);
    });
}

function swapPlayers(player1, player2) {
    if (!player1 || !player2 || player1 === player2) return;
    
    const squadList = document.getElementById('squad-list');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫
    const player1Name = player1.dataset.playerName;
    const player2Name = player2.dataset.playerName;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    const next2 = player2.nextSibling;
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
    if (player1.nextSibling === player2) {
        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫–∏ —Ä—è–¥–æ–º
        squadList.insertBefore(player2, player1);
    } else {
        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫–∏ –Ω–µ —Ä—è–¥–æ–º
        squadList.insertBefore(player2, player1);
        squadList.insertBefore(player1, next2);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ selectedPlayer, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø–µ—Ä–µ–º–µ—â–µ–Ω
    if (selectedPlayer) {
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ –∏–º–µ–Ω–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        const newSelectedElement = Array.from(squadList.querySelectorAll('.player-item')).find(
            item => item.dataset.playerName === selectedPlayer.dataset.playerName
        );
        if (newSelectedElement) {
            selectedPlayer = newSelectedElement;
        }
        selectedPlayer.classList.remove('selected-for-swap');
        selectedPlayer = null;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–∞–≤
    updateLineup();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–∞–∫—Ç–∏–∫–∏
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('select-tactic-btn')) {
        const tacticKey = e.target.dataset.tactic;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞–∫—Ç–∏–∫–∏
        fetch('/change_tactic', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tactic: tacticKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç–∞–∫—Ç–∏–∫—É
                document.querySelectorAll('.tactic-card').forEach(card => {
                    card.classList.remove('active');
                });
                e.target.closest('.tactic-card').classList.add('active');

                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ç–∞–∫—Ç–∏–∫–∏
                const tacticNames = {
                    'balanced': '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞',
                    'tiki_taka': '–¢–∏–∫–∏-—Ç–∞–∫–∞',
                    'catenaccio': '–ö–∞—Ç–µ–Ω–∞—á—á–æ',
                    'bus': '–ê–≤—Ç–æ–±—É—Å',
                    'all_out_attack': '–í—Å–µ –≤ –∞—Ç–∞–∫—É'
                };
                document.getElementById('current-tactic-name').textContent = tacticNames[tacticKey];

                alert('‚úÖ ' + data.message);
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–∫—Ç–∏–∫–∏:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–∫—Ç–∏–∫–∏');
        });
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initSwapSystem();

    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–∫—Ç–∏–∫—É
    const content = document.getElementById('tactic-content');
    if (content) {
        content.style.display = 'none';
        const toggle = document.getElementById('tactic-toggle');
        if (toggle) {
            toggle.textContent = '‚ñ∂';
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–∏ —Ç–∞–∫—Ç–∏–∫–∏
function toggleTactics() {
    const content = document.getElementById('tactic-content');
    const toggle = document.getElementById('tactic-toggle');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

function getPositionByIndex(index) {
    if (index === 0) return '–í';  // –í—Ä–∞—Ç–∞—Ä—å
    if (index >= 1 && index <= 4) return '–ó';  // –ó–∞—â–∏—Ç–Ω–∏–∫–∏
    if (index >= 5 && index <= 8) return '–ü';  // –ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫–∏
    if (index >= 9 && index <= 10) return '–ù';  // –ù–∞–ø–∞–¥–µ–Ω–∏–µ
    return '-';
}

function updateLineup() {
    const squadList = document.getElementById('squad-list');
    const allItems = Array.from(squadList.querySelectorAll('.player-item'));
    const playerOrder = allItems
        .slice(0, 11)
        .map(item => item.dataset.playerName)
        .filter(name => name);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    document.getElementById('selected-count').textContent = playerOrder.length;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∏ –ø–æ–∑–∏—Ü–∏–∏
    allItems.forEach((item, index) => {
        if (index < 11) {
            item.classList.remove('player-bench');
            item.classList.add('player-main');
            item.dataset.positionIndex = index;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
            const positionSpan = item.querySelector('.player-position');
            if (positionSpan) {
                positionSpan.textContent = getPositionByIndex(index);
            }
            
            if (!item.dataset.playerName) {
                item.classList.add('player-empty');
            } else {
                item.classList.remove('player-empty');
            }
        } else {
            item.classList.remove('player-main', 'player-empty');
            item.classList.add('player-bench');
            const positionSpan = item.querySelector('.player-position');
            if (positionSpan) {
                positionSpan.textContent = '-';
            }
        }
    });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    selectedPlayer = null;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    document.querySelectorAll('.player-item').forEach(item => {
        delete item.dataset.hasClickHandler;
        item.classList.remove('selected-for-swap');
    });
    
    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É swap –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
    requestAnimationFrame(() => {
        initSwapSystem();
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('{{ url_for("update_lineup") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            player_order: playerOrder
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}
