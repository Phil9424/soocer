{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="game-page">
        <div class="team-header">
            <h1>ğŸ‘¥ Ğ¡Ğ¾ÑÑ‚Ğ°Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ - <span id="selected-count" style="color: var(--accent-yellow);">{{ (data.selected_players|default([]))|length }}</span>/11</h1>
        </div>
        
        <div class="squad-list" id="squad-list">
            {% set selected_players_list = data.selected_players|default([]) %}
            
            {# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞ¾ÑÑ‚Ğ°Ğ² (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 11) #}
            {% for i in range(11) %}
                {% if i < selected_players_list|length %}
                    {% set player_name = selected_players_list[i] %}
                    {% set player = data.squad|selectattr("name", "equalto", player_name)|first %}
                    {% if player %}
                        {# ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¼ĞµÑÑ‚Ğ°: 1=Ğ’, 2-5=Ğ—, 6-9=ĞŸ, 10-11=Ğ #}
                        {% if i == 0 %}
                            {% set position = 'Ğ’' %}
                        {% elif i >= 1 and i <= 4 %}
                            {% set position = 'Ğ—' %}
                        {% elif i >= 5 and i <= 8 %}
                            {% set position = 'ĞŸ' %}
                        {% else %}
                            {% set position = 'Ğ' %}
                        {% endif %}
                    <div class="player-item player-main" data-player-name="{{ player.name }}" data-position-index="{{ i }}">
                        <span class="player-position">{{ position }}</span>
                        <span class="player-name">{{ player.name }}</span>
                        {% if player.get('injury') or player.get('cards') %}
                        <span class="player-status">
                            {% if player.get('injury') %}ğŸ¥{% endif %}
                            {% if player.get('cards') == 1 %}ğŸŸ¨{% elif player.get('cards') == 2 %}ğŸŸ¥{% endif %}
                        </span>
                        {% endif %}
                        <span class="player-rating">{{ player.rating }}</span>
                    </div>
                    {% endif %}
                {% else %}
                    {# ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿ÑƒÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑ‚Ğ° #}
                    {% if i == 0 %}
                        {% set position = 'Ğ’' %}
                    {% elif i >= 1 and i <= 4 %}
                        {% set position = 'Ğ—' %}
                    {% elif i >= 5 and i <= 8 %}
                        {% set position = 'ĞŸ' %}
                    {% else %}
                        {% set position = 'Ğ' %}
                    {% endif %}
                    <div class="player-item player-main player-empty" data-position-index="{{ i }}">
                        <span class="player-position">{{ position }}</span>
                        <span class="player-name">ĞŸÑƒÑÑ‚Ğ¾</span>
                        <span class="player-rating">-</span>
                    </div>
                {% endif %}
            {% endfor %}
            
            {# Ğ—Ğ°Ğ¿Ğ°ÑĞ½Ñ‹Ğµ #}
            {% for player in data.squad %}
                {% if player.name not in selected_players_list %}
                <div class="player-item player-bench" data-player-name="{{ player.name }}">
                    <span class="player-position">-</span>
                    <span class="player-name">{{ player.name }}</span>
                    {% if player.get('injury') or player.get('cards') %}
                    <span class="player-status">
                        {% if player.get('injury') %}ğŸ¥{% endif %}
                        {% if player.get('cards') == 1 %}ğŸŸ¨{% elif player.get('cards') == 2 %}ğŸŸ¥{% endif %}
                    </span>
                    {% endif %}
                    <span class="player-rating">{{ player.rating }}</span>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <div class="page-navigation">
            <a href="{{ url_for('game_page', page=2) }}" class="nav-btn">â—€ ĞĞ°Ğ·Ğ°Ğ´</a>
            <span class="page-indicator">ğŸ“„ 3/5</span>
            <a href="{{ url_for('game_page', page=4) }}" class="nav-btn">Ğ’Ğ¿ĞµÑ€Ñ‘Ğ´ â–¶</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedPlayer = null;

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ»Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
function handlePlayerClick(e) {
    e.stopPropagation();
    const item = this;
    
    if (item.classList.contains('player-empty')) return;
    
    // Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½, Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞµĞ³Ğ¾
    if (!selectedPlayer) {
        selectedPlayer = item;
        item.classList.add('selected-for-swap');
        return;
    }
    
    // Ğ•ÑĞ»Ğ¸ ĞºĞ»Ğ¸ĞºĞ½ÑƒĞ»Ğ¸ Ğ½Ğ° Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°, ÑĞ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
    if (selectedPlayer === item) {
        selectedPlayer.classList.remove('selected-for-swap');
        selectedPlayer = null;
        return;
    }
    
    // ĞœĞµĞ½ÑĞµĞ¼ Ğ¼ĞµÑÑ‚Ğ°Ğ¼Ğ¸ Ğ´Ğ²ÑƒÑ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
    swapPlayers(selectedPlayer, item);
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ swap (ĞºĞ»Ğ¸Ğº Ğ½Ğ° Ğ´Ğ²ÑƒÑ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°Ñ…)
function initSwapSystem() {
    // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑĞµ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ
    document.querySelectorAll('.player-item:not(.player-empty)').forEach(item => {
        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ±Ñ‹Ğ» Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· addEventListener
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚
        newItem.addEventListener('click', handlePlayerClick);
    });
}

function swapPlayers(player1, player2) {
    if (!player1 || !player2 || player1 === player2) return;
    
    const squadList = document.getElementById('squad-list');
    
    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑÑ‹Ğ»Ğ¾Ğº
    const player1Name = player1.dataset.playerName;
    const player2Name = player2.dataset.playerName;
    
    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
    const next2 = player2.nextSibling;
    
    // ĞœĞµĞ½ÑĞµĞ¼ Ğ¼ĞµÑÑ‚Ğ°Ğ¼Ğ¸
    if (player1.nextSibling === player2) {
        // Ğ•ÑĞ»Ğ¸ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸ Ñ€ÑĞ´Ğ¾Ğ¼
        squadList.insertBefore(player2, player1);
    } else {
        // Ğ•ÑĞ»Ğ¸ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸ Ğ½Ğµ Ñ€ÑĞ´Ğ¾Ğ¼
        squadList.insertBefore(player2, player1);
        squadList.insertBefore(player1, next2);
    }
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° selectedPlayer, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ±Ñ‹Ğ» Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½
    if (selectedPlayer) {
        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ñ
        const newSelectedElement = Array.from(squadList.querySelectorAll('.player-item')).find(
            item => item.dataset.playerName === selectedPlayer.dataset.playerName
        );
        if (newSelectedElement) {
            selectedPlayer = newSelectedElement;
        }
        selectedPlayer.classList.remove('selected-for-swap');
        selectedPlayer = null;
    }
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ°Ğ²
    updateLineup();
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
document.addEventListener('DOMContentLoaded', function() {
    initSwapSystem();
});

function getPositionByIndex(index) {
    if (index === 0) return 'Ğ’';  // Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ
    if (index >= 1 && index <= 4) return 'Ğ—';  // Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸ĞºĞ¸
    if (index >= 5 && index <= 8) return 'ĞŸ';  // ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸ĞºĞ¸
    if (index >= 9 && index <= 10) return 'Ğ';  // ĞĞ°Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ
    return '-';
}

function updateLineup() {
    const squadList = document.getElementById('squad-list');
    const allItems = Array.from(squadList.querySelectorAll('.player-item'));
    const playerOrder = allItems
        .slice(0, 11)
        .map(item => item.dataset.playerName)
        .filter(name => name);
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº
    document.getElementById('selected-count').textContent = playerOrder.length;
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°ÑÑÑ‹ Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
    allItems.forEach((item, index) => {
        if (index < 11) {
            item.classList.remove('player-bench');
            item.classList.add('player-main');
            item.dataset.positionIndex = index;
            
            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
            const positionSpan = item.querySelector('.player-position');
            if (positionSpan) {
                positionSpan.textContent = getPositionByIndex(index);
            }
            
            if (!item.dataset.playerName) {
                item.classList.add('player-empty');
            } else {
                item.classList.remove('player-empty');
            }
        } else {
            item.classList.remove('player-main', 'player-empty');
            item.classList.add('player-bench');
            const positionSpan = item.querySelector('.player-position');
            if (positionSpan) {
                positionSpan.textContent = '-';
            }
        }
    });
    
    // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
    selectedPlayer = null;
    
    // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    document.querySelectorAll('.player-item').forEach(item => {
        delete item.dataset.hasClickHandler;
        item.classList.remove('selected-for-swap');
    });
    
    // ĞŸĞµÑ€ĞµĞ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ swap Ğ¿Ğ¾ÑĞ»Ğµ Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ DOM
    requestAnimationFrame(() => {
        initSwapSystem();
    });
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
    fetch('{{ url_for("update_lineup") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            player_order: playerOrder
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ°');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}
